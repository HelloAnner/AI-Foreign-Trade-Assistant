import{_ as O,y as A,h as B,r as M,w as R,g as S,k as r,o as a,b as e,e as d,v as p,n as J,F as h,m as U,z as C,A as q,l as N,t as _,p as T,x as z,B as P,j as K,C as W,c as F,a as Z,u as k}from"./index-C0WLIbIx.js";import{h as I,F as G}from"./http-DRwZa0kw.js";import{f as H,d as Q,b as X,u as Y,s as tt}from"./flow-yhy4zSAu.js";const et={class:"editor__backdrop",role:"dialog","aria-modal":"true"},st={key:0,class:"editor"},lt={class:"editor__content"},ot={class:"section"},at={class:"grid two"},nt={class:"full"},it={class:"section"},dt={key:0,class:"contacts"},rt=["onUpdate:modelValue"],ut=["onUpdate:modelValue"],pt=["onUpdate:modelValue"],mt=["onUpdate:modelValue"],yt=["onClick"],_t={key:1,class:"hint"},ft={class:"section"},bt={class:"grid two"},gt={class:"full"},ct={class:"section"},vt={class:"grid one"},wt={class:"section"},kt={key:0,class:"grid one"},Ct={key:1,class:"hint"},ht={class:"section"},Ut={class:"schedule"},xt={key:0,class:"schedule__current"},Vt={class:"schedule__options"},$t=["disabled","onClick"],St={key:1,class:"hint"},Nt={class:"editor__footer"},Dt=["disabled"],Et={key:1,class:"editor__loading"},Lt={__name:"CustomerEditModal",props:{customer:{type:Object,default:null},loading:{type:Boolean,default:!1}},emits:["close","updated"],setup(m,{emit:n}){const i=m,f=n,v=A(),s=B({id:null,name:"",website:"",country:"",summary:"",contacts:[],grade:"",gradeReason:"",analysis:{core_business:"",pain_points:"",my_entry_points:"",full_report:""},email:{email_id:null,subject:"",body:""},followup:{delay:null,next_due:""},sourceJSON:null}),y=B({grade:"",gradeReason:"",analysisEnabled:!1,emailEnabled:!1,followupDue:""}),u=[3,7,14],g=M(!1),D=o=>{if(!o)return"—";const t=new Date(o);return Number.isNaN(t.getTime())?o:t.toLocaleString()},E=o=>{o&&(s.id=o.id,s.name=o.name||"",s.website=o.website||"",s.country=o.country||"",s.summary=o.summary||"",s.contacts=(o.contacts||[]).map((t,l)=>({name:t.name||"",title:t.title||"",email:t.email||"",phone:t.phone||"",source:t.source||"",is_key:l===0||!!t.is_key})),s.grade=o.grade||"",s.gradeReason=o.grade_reason||"",s.analysis={core_business:o.analysis?.core_business||"",pain_points:o.analysis?.pain_points||"",my_entry_points:o.analysis?.my_entry_points||"",full_report:o.analysis?.full_report||""},s.email={email_id:o.email_draft?.email_id||null,subject:o.email_draft?.subject||"",body:o.email_draft?.body||""},s.followup={delay:null,next_due:o.scheduled_task?.due_at||""},s.sourceJSON=o.source_json||null,y.grade=s.grade,y.gradeReason=s.gradeReason,y.analysisEnabled=!!o.analysis,y.emailEnabled=!!o.email_draft,y.followupDue=s.followup.next_due)};R(()=>i.customer,o=>{E(o)},{immediate:!0});const w=()=>{g.value||f("close")},c=()=>{s.contacts.push({name:"",title:"",email:"",phone:"",source:"",is_key:s.contacts.length===0})},x=o=>{s.contacts.splice(o,1)},L=o=>{s.followup.delay=s.followup.delay===o?null:o},V=S(()=>{const o=s.contacts.map((t,l)=>({name:t.name?.trim()||"",title:t.title?.trim()||"",email:t.email?.trim()||"",phone:t.phone?.trim()||"",source:t.source?.trim()||"",is_key:l===0}));return o.length&&!o.some(t=>t.is_key)&&(o[0].is_key=!0),o}),j=async()=>{if(s.id){g.value=!0;try{const o={name:s.name,website:s.website,country:s.country,summary:s.summary,contacts:V.value};if(s.sourceJSON&&(o.source_json=s.sourceJSON),await H(s.id,o),s.grade&&(s.grade!==y.grade||s.gradeReason!==y.gradeReason)&&await Q(s.id,{grade:s.grade,reason:s.gradeReason?.trim()||""}),(s.analysis.core_business?.trim()||s.analysis.pain_points?.trim()||s.analysis.my_entry_points?.trim()||s.analysis.full_report?.trim())&&await X(s.id,{core_business:s.analysis.core_business,pain_points:s.analysis.pain_points,my_entry_points:s.analysis.my_entry_points,full_report:s.analysis.full_report}),s.email.email_id&&await Y(s.email.email_id,{subject:s.email.subject,body:s.email.body}),s.followup.delay&&s.email.email_id){const l=await tt({customer_id:s.id,context_email_id:s.email.email_id,delay_days:s.followup.delay});l?.ok&&l.data?.due_at&&(s.followup.next_due=l.data.due_at)}v.pushToast("客户信息已保存","success"),f("updated")}catch(o){console.error("Failed to save customer",o),v.pushToast(o.message||"保存客户信息失败","error")}finally{g.value=!1}}};return(o,t)=>(a(),r("div",et,[!m.loading&&s?(a(),r("div",st,[e("header",{class:"editor__header"},[t[13]||(t[13]=e("div",null,[e("h3",null,"编辑客户信息"),e("p",null,"一次性调整五个步骤的全部内容。")],-1)),e("button",{class:"icon-button",type:"button",onClick:w},[...t[12]||(t[12]=[e("span",{class:"material"},"close",-1)])])]),e("div",lt,[e("section",ot,[t[18]||(t[18]=e("h4",null,"基础信息",-1)),e("div",at,[e("label",null,[t[14]||(t[14]=e("span",null,"公司名称",-1)),d(e("input",{"onUpdate:modelValue":t[0]||(t[0]=l=>s.name=l),type:"text",placeholder:"如：环球贸易有限公司"},null,512),[[p,s.name]])]),e("label",null,[t[15]||(t[15]=e("span",null,"公司官网",-1)),d(e("input",{"onUpdate:modelValue":t[1]||(t[1]=l=>s.website=l),type:"text",placeholder:"https://example.com"},null,512),[[p,s.website]])]),e("label",null,[t[16]||(t[16]=e("span",null,"国家/地区",-1)),d(e("input",{"onUpdate:modelValue":t[2]||(t[2]=l=>s.country=l),type:"text",placeholder:"United States"},null,512),[[p,s.country]])]),e("label",nt,[t[17]||(t[17]=e("span",null,"公司摘要",-1)),d(e("textarea",{"onUpdate:modelValue":t[3]||(t[3]=l=>s.summary=l),rows:"3",placeholder:"公司业务概览"},null,512),[[p,s.summary]])])])]),e("section",it,[e("header",{class:"section__head"},[t[20]||(t[20]=e("h4",null,"潜在联系人",-1)),e("button",{type:"button",class:"ghost",onClick:c},[...t[19]||(t[19]=[e("span",{class:"material"},"add",-1),J(" 新增联系人 ",-1)])])]),s.contacts.length?(a(),r("div",dt,[(a(!0),r(h,null,U(s.contacts,(l,$)=>(a(),r("div",{key:$,class:"contact-row"},[d(e("input",{"onUpdate:modelValue":b=>l.name=b,type:"text",placeholder:"姓名"},null,8,rt),[[p,l.name]]),d(e("input",{"onUpdate:modelValue":b=>l.title=b,type:"text",placeholder:"职位"},null,8,ut),[[p,l.title]]),d(e("input",{"onUpdate:modelValue":b=>l.email=b,type:"email",placeholder:"邮箱"},null,8,pt),[[p,l.email]]),d(e("input",{"onUpdate:modelValue":b=>l.phone=b,type:"text",placeholder:"电话（选填）"},null,8,mt),[[p,l.phone]]),e("button",{class:"icon-button",type:"button",onClick:b=>x($)},[...t[21]||(t[21]=[e("span",{class:"material"},"delete",-1)])],8,yt)]))),128))])):(a(),r("p",_t,"暂无联系人，点击“新增联系人”补充关键联系人。"))]),e("section",ft,[t[25]||(t[25]=e("h4",null,"AI 评级",-1)),e("div",bt,[e("label",null,[t[23]||(t[23]=e("span",null,"最终评级",-1)),d(e("select",{"onUpdate:modelValue":t[4]||(t[4]=l=>s.grade=l)},[...t[22]||(t[22]=[q('<option value="" data-v-afd7f1b6>未评级</option><option value="S" data-v-afd7f1b6>S</option><option value="A" data-v-afd7f1b6>A</option><option value="B" data-v-afd7f1b6>B</option><option value="C" data-v-afd7f1b6>C</option><option value="UNKNOWN" data-v-afd7f1b6>UNKNOWN</option>',6)])],512),[[C,s.grade]])]),e("label",gt,[t[24]||(t[24]=e("span",null,"评级理由",-1)),d(e("textarea",{"onUpdate:modelValue":t[5]||(t[5]=l=>s.gradeReason=l),rows:"3",placeholder:"说明评级的主要依据"},null,512),[[p,s.gradeReason]])])])]),e("section",ct,[t[30]||(t[30]=e("h4",null,"客户深度分析",-1)),e("div",vt,[e("label",null,[t[26]||(t[26]=e("span",null,"客户核心业务",-1)),d(e("textarea",{"onUpdate:modelValue":t[6]||(t[6]=l=>s.analysis.core_business=l),rows:"3"},null,512),[[p,s.analysis.core_business]])]),e("label",null,[t[27]||(t[27]=e("span",null,"潜在需求 / 痛点",-1)),d(e("textarea",{"onUpdate:modelValue":t[7]||(t[7]=l=>s.analysis.pain_points=l),rows:"3"},null,512),[[p,s.analysis.pain_points]])]),e("label",null,[t[28]||(t[28]=e("span",null,"我方切入点",-1)),d(e("textarea",{"onUpdate:modelValue":t[8]||(t[8]=l=>s.analysis.my_entry_points=l),rows:"3"},null,512),[[p,s.analysis.my_entry_points]])]),e("label",null,[t[29]||(t[29]=e("span",null,"完整报告",-1)),d(e("textarea",{"onUpdate:modelValue":t[9]||(t[9]=l=>s.analysis.full_report=l),rows:"5"},null,512),[[p,s.analysis.full_report]])])])]),e("section",wt,[t[33]||(t[33]=e("h4",null,"开发信草稿",-1)),s.email.email_id?(a(),r("div",kt,[e("label",null,[t[31]||(t[31]=e("span",null,"邮件标题",-1)),d(e("input",{"onUpdate:modelValue":t[10]||(t[10]=l=>s.email.subject=l),type:"text"},null,512),[[p,s.email.subject]])]),e("label",null,[t[32]||(t[32]=e("span",null,"邮件正文",-1)),d(e("textarea",{"onUpdate:modelValue":t[11]||(t[11]=l=>s.email.body=l),rows:"10"},null,512),[[p,s.email.body]])])])):(a(),r("p",Ct,"尚未生成开发信草稿，请在主流程中生成后再进行编辑。"))]),e("section",ht,[t[35]||(t[35]=e("h4",null,"自动跟进计划",-1)),e("div",Ut,[s.followup.next_due?(a(),r("div",xt,[t[34]||(t[34]=e("span",{class:"label"},"当前计划",-1)),e("span",null,_(D(s.followup.next_due)),1)])):N("",!0),e("div",Vt,[(a(),r(h,null,U(u,l=>e("button",{key:l,type:"button",class:T(["ghost",{active:s.followup.delay===l}]),disabled:!s.email.email_id,onClick:$=>L(l)},_(l)+" 天后 ",11,$t)),64))]),s.email.email_id?N("",!0):(a(),r("p",St,"保存前需要先有开发信草稿才能设置自动跟进。"))])])]),e("footer",Nt,[e("button",{class:"ghost",type:"button",onClick:w},"取消"),e("button",{class:"primary",type:"button",disabled:g.value,onClick:j},_(g.value?"保存中…":"保存"),9,Dt)])])):(a(),r("div",Et,[...t[36]||(t[36]=[e("div",{class:"spinner"},null,-1),e("p",null,"加载客户信息…",-1)])]))]))}},jt=O(Lt,[["__scopeId","data-v-afd7f1b6"]]),At=async(m={})=>{const{data:n}=await I.get("/customers",{params:m});return n},Bt=async m=>{const{data:n}=await I.get(`/customers/${m}`);return n},Ft=z("customers",{state:()=>({loading:!1,items:[],filters:{grade:"",country:"",status:"",sort:"last_followup_desc",q:""},detailLoading:!1,detail:null}),actions:{async fetchList(m={}){const n=A();this.loading=!0;try{const i={...this.filters,...m};i.q||delete i.q;const f=await At(i);f.ok?this.items=f.data||[]:n.pushToast(f.error||"加载客户列表失败","error")}catch(i){console.error("Failed to load customers",i),n.pushToast(i.message,"error")}finally{this.loading=!1}},setFilter(m,n){Object.prototype.hasOwnProperty.call(this.filters,m)&&(this.filters[m]=n)},async fetchDetail(m){const n=A();this.detailLoading=!0;try{const i=await Bt(m);i.ok?this.detail=i.data:n.pushToast(i.error||"加载客户详情失败","error")}catch(i){console.error("Failed to load customer detail",i),n.pushToast(i.message,"error")}finally{this.detailLoading=!1}},clearDetail(){this.detail=null}}}),Ot={class:"customers"},Rt={class:"customers__toolbar"},Tt={class:"customers__filter"},It=["value"],Mt={class:"customers__filter"},Jt=["value"],qt={class:"customers__filter"},zt={class:"customers__filter"},Pt={class:"customers__table"},Kt={key:0},Wt={key:1},Zt={class:"name"},Gt={class:"title"},Ht={class:"hint"},Qt={class:"actions"},Xt=["onClick"],Yt={__name:"CustomersPage",setup(m){const n=Ft(),{items:i,loading:f,detail:v,detailLoading:s,filters:y}=P(n),u=B({grade:y.value.grade,country:y.value.country,status:y.value.status,sort:y.value.sort}),g=S(()=>{const o=new Set(["S","A","B","C"]);return i.value.forEach(t=>{t.grade&&o.add(t.grade)}),Array.from(o)}),D=S(()=>{const o=new Set;return i.value.forEach(t=>{t.country&&o.add(t.country)}),Array.from(o).sort()}),E=S(()=>s.value||!!v.value),w=()=>{n.fetchList()},c=(o,t)=>{n.setFilter(o,t),w()};R(y,o=>{u.grade=o.grade,u.country=o.country,u.status=o.status,u.sort=o.sort});const x=o=>{if(!o)return"—";const t=new Date(o);return Number.isNaN(t.getTime())?o:t.toLocaleDateString()},L=async o=>{await n.fetchDetail(o)},V=()=>{n.clearDetail()},j=()=>{V(),w()};return K(()=>{n.fetchList()}),W(()=>{}),(o,t)=>(a(),F(G,{step:0,total:0,title:"客户列表",subtitle:"集中查看并维护所有客户数据。"},{default:Z(()=>[e("section",Ot,[e("header",Rt,[e("label",Tt,[t[9]||(t[9]=e("span",null,"评级",-1)),d(e("select",{"onUpdate:modelValue":t[0]||(t[0]=l=>u.grade=l),onChange:t[1]||(t[1]=l=>c("grade",u.grade))},[t[8]||(t[8]=e("option",{value:""},"全部",-1)),(a(!0),r(h,null,U(g.value,l=>(a(),r("option",{key:l,value:l},_(l),9,It))),128))],544),[[C,u.grade]])]),e("label",Mt,[t[11]||(t[11]=e("span",null,"国家/地区",-1)),d(e("select",{"onUpdate:modelValue":t[2]||(t[2]=l=>u.country=l),onChange:t[3]||(t[3]=l=>c("country",u.country))},[t[10]||(t[10]=e("option",{value:""},"全部",-1)),(a(!0),r(h,null,U(D.value,l=>(a(),r("option",{key:l,value:l},_(l),9,Jt))),128))],544),[[C,u.country]])]),e("label",qt,[t[13]||(t[13]=e("span",null,"跟进状态",-1)),d(e("select",{"onUpdate:modelValue":t[4]||(t[4]=l=>u.status=l),onChange:t[5]||(t[5]=l=>c("status",u.status))},[...t[12]||(t[12]=[e("option",{value:""},"全部",-1),e("option",{value:"pending"},"待跟进",-1),e("option",{value:"in_progress"},"跟进中",-1),e("option",{value:"won"},"已成交",-1)])],544),[[C,u.status]])]),e("label",zt,[t[15]||(t[15]=e("span",null,"排序",-1)),d(e("select",{"onUpdate:modelValue":t[6]||(t[6]=l=>u.sort=l),onChange:t[7]||(t[7]=l=>c("sort",u.sort))},[...t[14]||(t[14]=[e("option",{value:"last_followup_desc"},"按最近跟进",-1),e("option",{value:"last_followup_asc"},"按最早跟进",-1),e("option",{value:"name_asc"},"按公司名 A → Z",-1),e("option",{value:"name_desc"},"按公司名 Z → A",-1)])],544),[[C,u.sort]])])]),e("div",Pt,[e("table",null,[t[18]||(t[18]=e("thead",null,[e("tr",null,[e("th",null,"公司"),e("th",null,"国家/地区"),e("th",null,"评级"),e("th",null,"最后跟进"),e("th",{class:"actions"},"操作")])],-1)),e("tbody",null,[k(f)?(a(),r("tr",Kt,[...t[16]||(t[16]=[e("td",{colspan:"5",class:"empty"},"加载中…",-1)])])):k(i).length?N("",!0):(a(),r("tr",Wt,[...t[17]||(t[17]=[e("td",{colspan:"5",class:"empty"},"暂无客户记录",-1)])])),(a(!0),r(h,null,U(k(i),l=>(a(),r("tr",{key:l.id},[e("td",Zt,[e("p",Gt,_(l.name),1),e("p",Ht,"最近更新时间："+_(x(l.updated_at)),1)]),e("td",null,_(l.country||"—"),1),e("td",null,[e("span",{class:T(["badge",`badge--${(l.grade||"unknown").toLowerCase()}`])},_(l.grade),3)]),e("td",null,_(x(l.last_followup_at)),1),e("td",Qt,[e("button",{type:"button",onClick:$=>L(l.id)},"编辑",8,Xt)])]))),128))])])])]),E.value?(a(),F(jt,{key:0,customer:k(v),loading:k(s),onClose:V,onUpdated:j},null,8,["customer","loading"])):N("",!0)]),_:1}))}},le=O(Yt,[["__scopeId","data-v-959b5bb3"]]);export{le as default};
