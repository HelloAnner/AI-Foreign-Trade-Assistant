import{x as r,y as i}from"./index-Ch9j_YPl.js";import{s as o,u,a as n,g as h,b as c,c as d,d as m,e as y,r as f,f as p,h as g,i as w}from"./flow-ZQ2Q-dTR.js";const T=r("flow",{state:()=>({step:1,query:"",resolving:!1,resolveResult:null,contacts:[],summary:"",country:"",website:"",customerId:null,gradeSuggestion:null,gradeFinal:null,analysis:null,emailDraft:null,followupId:null,scheduledTask:null,loading:{grade:!1,analysis:!1,email:!1,followup:!1,schedule:!1}}),actions:{resetFlow(){this.step=1,this.query="",this.resolving=!1,this.resolveResult=null,this.contacts=[],this.summary="",this.country="",this.website="",this.customerId=null,this.gradeSuggestion=null,this.gradeFinal=null,this.analysis=null,this.emailDraft=null,this.followupId=null,this.scheduledTask=null,this.loading={grade:!1,analysis:!1,email:!1,followup:!1,schedule:!1}},async startResolve(t){const s=i();this.resolving=!0,this.query=t;try{const a=(await w(t)).data||{};if(this.resolveResult=a,this.contacts=(a.contacts||[]).map(l=>({...l})),this.summary=a.summary||"",this.country=a.country||"",this.website=a.website||"",a.customer_id){this.customerId=a.customer_id;const l=(a.grade||"").toUpperCase();l&&l!=="UNKNOWN"?this.gradeFinal={grade:l,reason:a.grade_reason||""}:this.gradeFinal=null,this.analysis=a.analysis?{...a.analysis}:null,this.emailDraft=a.email_draft?{...a.email_draft}:null,this.followupId=a.followup_id||null,this.scheduledTask=a.scheduled_task||null,this.step=Math.max(1,a.last_step||1)}else this.customerId=null,this.gradeFinal=null,this.analysis=null,this.emailDraft=null,this.followupId=null,this.scheduledTask=null,this.step=1;this.gradeSuggestion=null}catch(e){s.pushToast(e.message,"error")}finally{this.resolving=!1}},async saveCompany(t){const s=i(),e={name:t.name,website:t.website||this.website,country:t.country||this.country,summary:t.summary||this.summary,contacts:this.contacts};this.resolveResult&&typeof this.resolveResult=="object"&&(e.source_json=this.resolveResult);try{if(this.customerId)await p(this.customerId,e),s.pushToast("客户信息已更新","success");else{const a=await g(e);this.customerId=a.data.customer_id,s.pushToast("客户信息已保存","success")}this.website=e.website,this.country=e.country,this.summary=e.summary,this.step=Math.max(this.step,2),this.resolveResult={...this.resolveResult&&typeof this.resolveResult=="object"?this.resolveResult:{},customer_id:this.customerId,name:e.name,website:e.website,country:e.country,summary:e.summary,contacts:(e.contacts||[]).map(a=>({...a})),last_step:Math.max(this.step,2)}}catch(a){s.pushToast(a.message,"error")}},async updateContacts(t){const s=i();if(this.contacts=t,!!this.customerId)try{await f(this.customerId,t),s.pushToast("联系人已更新","success")}catch(e){s.pushToast(e.message,"error")}},async fetchGrade(){if(!this.customerId)return;const t=i();this.loading.grade=!0;try{const s=await y(this.customerId);this.gradeSuggestion=s.data}catch(s){t.pushToast(s.message,"error")}finally{this.loading.grade=!1}},async confirmGrade(t,s=""){if(!this.customerId)return;const e=i();try{await m(this.customerId,{grade:t,reason:s}),this.gradeFinal={grade:t,reason:s},t==="A"?this.step=3:(this.step=5,e.pushToast("非 A 级客户，流程已归档","info"))}catch(a){e.pushToast(a.message,"error")}},async fetchAnalysis(){if(!this.customerId)return;const t=i();this.loading.analysis=!0;try{const s=await d(this.customerId);this.analysis=s.data,this.step=3}catch(s){t.pushToast(s.message,"error")}finally{this.loading.analysis=!1}},async persistAnalysis(){if(!this.customerId||!this.analysis)return;const t=i();try{await c(this.customerId,{core_business:this.analysis.core_business,pain_points:this.analysis.pain_points,my_entry_points:this.analysis.my_entry_points,full_report:this.analysis.full_report}),t.pushToast("分析内容已更新","success")}catch(s){t.pushToast(s.message,"error")}},async generateEmail(){if(!this.customerId)return;const t=i();this.loading.email=!0;try{const s=await h(this.customerId);this.emailDraft=s.data,this.step=4}catch(s){t.pushToast(s.message,"error")}finally{this.loading.email=!1}},async saveInitialFollowup(t=""){if(!this.customerId||!this.emailDraft)return;const s=i();this.loading.followup=!0;try{await u(this.emailDraft.email_id,{subject:this.emailDraft.subject,body:this.emailDraft.body});const e=await n(this.customerId,this.emailDraft.email_id,t);this.followupId=e.data.followup_id,this.step=5,s.pushToast("首次跟进记录已保存","success")}catch(e){s.pushToast(e.message,"error")}finally{this.loading.followup=!1}},async createSchedule(t){if(!this.customerId||!this.emailDraft)return;const s=i();this.loading.schedule=!0;try{const e=await o({customer_id:this.customerId,context_email_id:this.emailDraft.email_id,delay_days:t});this.scheduledTask=e.data,s.pushToast(`已设置 ${t} 天后的自动跟进`,"success")}catch(e){s.pushToast(e.message,"error")}finally{this.loading.schedule=!1}}}});export{T as u};
