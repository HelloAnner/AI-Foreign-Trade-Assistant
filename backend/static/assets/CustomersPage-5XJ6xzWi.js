import{_ as O,y as S,h as j,r as I,w as R,g as N,k as p,o as r,b as t,e as u,v as y,n as J,F as U,m as $,z as C,A as q,l as D,t as c,p as M,x as z,B as P,j as K,C as W,c as B,a as Z,u as k}from"./index-Ch9j_YPl.js";import{h as A,F as G}from"./http-BlT6ntru.js";import{f as H,d as Q,b as X,u as Y,s as tt}from"./flow-ZQ2Q-dTR.js";const et={class:"editor__backdrop",role:"dialog","aria-modal":"true"},st={key:0,class:"editor"},lt={class:"editor__content"},ot={class:"section"},at={class:"grid two"},nt={class:"full"},it={class:"section"},rt={key:0,class:"contacts"},dt=["onUpdate:modelValue"],ut=["onUpdate:modelValue"],pt=["onUpdate:modelValue"],mt=["onUpdate:modelValue"],yt=["onClick"],ft={key:1,class:"hint"},_t={class:"section"},ct={class:"grid two"},bt={class:"full"},gt={class:"section"},vt={class:"grid one"},wt={class:"section"},ht={key:0,class:"grid one"},kt={key:1,class:"hint"},Ct={class:"section"},Ut={class:"schedule"},$t={key:0,class:"schedule__current"},xt={class:"schedule__options"},Vt=["disabled","onClick"],St={key:1,class:"hint"},Nt={class:"editor__footer"},Dt=["disabled"],Tt={key:1,class:"editor__loading"},Lt={__name:"CustomerEditModal",props:{customer:{type:Object,default:null},loading:{type:Boolean,default:!1}},emits:["close","updated"],setup(d,{emit:n}){const i=d,b=n,w=S(),l=j({id:null,name:"",website:"",country:"",summary:"",contacts:[],grade:"",gradeReason:"",analysis:{core_business:"",pain_points:"",my_entry_points:"",full_report:""},email:{email_id:null,subject:"",body:""},followup:{delay:null,next_due:""},sourceJSON:null}),f=j({grade:"",gradeReason:"",analysisEnabled:!1,emailEnabled:!1,followupDue:""}),m=[3,7,14],g=I(!1),T=o=>{if(!o)return"—";const e=new Date(o);return Number.isNaN(e.getTime())?o:e.toLocaleString()},L=o=>{o&&(l.id=o.id,l.name=o.name||"",l.website=o.website||"",l.country=o.country||"",l.summary=o.summary||"",l.contacts=(o.contacts||[]).map((e,s)=>({name:e.name||"",title:e.title||"",email:e.email||"",phone:e.phone||"",source:e.source||"",is_key:s===0||!!e.is_key})),l.grade=o.grade||"",l.gradeReason=o.grade_reason||"",l.analysis={core_business:o.analysis?.core_business||"",pain_points:o.analysis?.pain_points||"",my_entry_points:o.analysis?.my_entry_points||"",full_report:o.analysis?.full_report||""},l.email={email_id:o.email_draft?.email_id||null,subject:o.email_draft?.subject||"",body:o.email_draft?.body||""},l.followup={delay:null,next_due:o.scheduled_task?.due_at||""},l.sourceJSON=o.source_json||null,f.grade=l.grade,f.gradeReason=l.gradeReason,f.analysisEnabled=!!o.analysis,f.emailEnabled=!!o.email_draft,f.followupDue=l.followup.next_due)};R(()=>i.customer,o=>{L(o)},{immediate:!0});const h=()=>{g.value||b("close")},v=()=>{l.contacts.push({name:"",title:"",email:"",phone:"",source:"",is_key:l.contacts.length===0})},x=o=>{l.contacts.splice(o,1)},E=o=>{l.followup.delay=l.followup.delay===o?null:o},V=N(()=>{const o=l.contacts.map((e,s)=>({name:e.name?.trim()||"",title:e.title?.trim()||"",email:e.email?.trim()||"",phone:e.phone?.trim()||"",source:e.source?.trim()||"",is_key:s===0}));return o.length&&!o.some(e=>e.is_key)&&(o[0].is_key=!0),o}),F=async()=>{if(l.id){g.value=!0;try{const o={name:l.name,website:l.website,country:l.country,summary:l.summary,contacts:V.value};if(l.sourceJSON&&(o.source_json=l.sourceJSON),await H(l.id,o),l.grade&&(l.grade!==f.grade||l.gradeReason!==f.gradeReason)&&await Q(l.id,{grade:l.grade,reason:l.gradeReason?.trim()||""}),(l.analysis.core_business?.trim()||l.analysis.pain_points?.trim()||l.analysis.my_entry_points?.trim()||l.analysis.full_report?.trim())&&await X(l.id,{core_business:l.analysis.core_business,pain_points:l.analysis.pain_points,my_entry_points:l.analysis.my_entry_points,full_report:l.analysis.full_report}),l.email.email_id&&await Y(l.email.email_id,{subject:l.email.subject,body:l.email.body}),l.followup.delay&&l.email.email_id){const s=await tt({customer_id:l.id,context_email_id:l.email.email_id,delay_days:l.followup.delay});s?.ok&&s.data?.due_at&&(l.followup.next_due=s.data.due_at)}w.pushToast("客户信息已保存","success"),b("updated")}catch(o){console.error("Failed to save customer",o),w.pushToast(o.message||"保存客户信息失败","error")}finally{g.value=!1}}};return(o,e)=>(r(),p("div",et,[!d.loading&&l?(r(),p("div",st,[t("header",{class:"editor__header"},[e[13]||(e[13]=t("div",null,[t("h3",null,"编辑客户信息"),t("p",null,"一次性调整五个步骤的全部内容。")],-1)),t("button",{class:"icon-button",type:"button",onClick:h},[...e[12]||(e[12]=[t("span",{class:"material"},"close",-1)])])]),t("div",lt,[t("section",ot,[e[18]||(e[18]=t("h4",null,"基础信息",-1)),t("div",at,[t("label",null,[e[14]||(e[14]=t("span",null,"公司名称",-1)),u(t("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>l.name=s),type:"text",placeholder:"如：环球贸易有限公司"},null,512),[[y,l.name]])]),t("label",null,[e[15]||(e[15]=t("span",null,"公司官网",-1)),u(t("input",{"onUpdate:modelValue":e[1]||(e[1]=s=>l.website=s),type:"text",placeholder:"https://example.com"},null,512),[[y,l.website]])]),t("label",null,[e[16]||(e[16]=t("span",null,"国家/地区",-1)),u(t("input",{"onUpdate:modelValue":e[2]||(e[2]=s=>l.country=s),type:"text",placeholder:"United States"},null,512),[[y,l.country]])]),t("label",nt,[e[17]||(e[17]=t("span",null,"公司摘要",-1)),u(t("textarea",{"onUpdate:modelValue":e[3]||(e[3]=s=>l.summary=s),rows:"3",placeholder:"公司业务概览"},null,512),[[y,l.summary]])])])]),t("section",it,[t("header",{class:"section__head"},[e[20]||(e[20]=t("h4",null,"潜在联系人",-1)),t("button",{type:"button",class:"ghost",onClick:v},[...e[19]||(e[19]=[t("span",{class:"material"},"add",-1),J(" 新增联系人 ",-1)])])]),l.contacts.length?(r(),p("div",rt,[(r(!0),p(U,null,$(l.contacts,(s,a)=>(r(),p("div",{key:a,class:"contact-row"},[u(t("input",{"onUpdate:modelValue":_=>s.name=_,type:"text",placeholder:"姓名"},null,8,dt),[[y,s.name]]),u(t("input",{"onUpdate:modelValue":_=>s.title=_,type:"text",placeholder:"职位"},null,8,ut),[[y,s.title]]),u(t("input",{"onUpdate:modelValue":_=>s.email=_,type:"email",placeholder:"邮箱"},null,8,pt),[[y,s.email]]),u(t("input",{"onUpdate:modelValue":_=>s.phone=_,type:"text",placeholder:"电话（选填）"},null,8,mt),[[y,s.phone]]),t("button",{class:"icon-button",type:"button",onClick:_=>x(a)},[...e[21]||(e[21]=[t("span",{class:"material"},"delete",-1)])],8,yt)]))),128))])):(r(),p("p",ft,"暂无联系人，点击“新增联系人”补充关键联系人。"))]),t("section",_t,[e[25]||(e[25]=t("h4",null,"AI 评级",-1)),t("div",ct,[t("label",null,[e[23]||(e[23]=t("span",null,"最终评级",-1)),u(t("select",{"onUpdate:modelValue":e[4]||(e[4]=s=>l.grade=s)},[...e[22]||(e[22]=[q('<option value="" data-v-afd7f1b6>未评级</option><option value="S" data-v-afd7f1b6>S</option><option value="A" data-v-afd7f1b6>A</option><option value="B" data-v-afd7f1b6>B</option><option value="C" data-v-afd7f1b6>C</option><option value="UNKNOWN" data-v-afd7f1b6>UNKNOWN</option>',6)])],512),[[C,l.grade]])]),t("label",bt,[e[24]||(e[24]=t("span",null,"评级理由",-1)),u(t("textarea",{"onUpdate:modelValue":e[5]||(e[5]=s=>l.gradeReason=s),rows:"3",placeholder:"说明评级的主要依据"},null,512),[[y,l.gradeReason]])])])]),t("section",gt,[e[30]||(e[30]=t("h4",null,"客户深度分析",-1)),t("div",vt,[t("label",null,[e[26]||(e[26]=t("span",null,"客户核心业务",-1)),u(t("textarea",{"onUpdate:modelValue":e[6]||(e[6]=s=>l.analysis.core_business=s),rows:"3"},null,512),[[y,l.analysis.core_business]])]),t("label",null,[e[27]||(e[27]=t("span",null,"潜在需求 / 痛点",-1)),u(t("textarea",{"onUpdate:modelValue":e[7]||(e[7]=s=>l.analysis.pain_points=s),rows:"3"},null,512),[[y,l.analysis.pain_points]])]),t("label",null,[e[28]||(e[28]=t("span",null,"我方切入点",-1)),u(t("textarea",{"onUpdate:modelValue":e[8]||(e[8]=s=>l.analysis.my_entry_points=s),rows:"3"},null,512),[[y,l.analysis.my_entry_points]])]),t("label",null,[e[29]||(e[29]=t("span",null,"完整报告",-1)),u(t("textarea",{"onUpdate:modelValue":e[9]||(e[9]=s=>l.analysis.full_report=s),rows:"5"},null,512),[[y,l.analysis.full_report]])])])]),t("section",wt,[e[33]||(e[33]=t("h4",null,"开发信草稿",-1)),l.email.email_id?(r(),p("div",ht,[t("label",null,[e[31]||(e[31]=t("span",null,"邮件标题",-1)),u(t("input",{"onUpdate:modelValue":e[10]||(e[10]=s=>l.email.subject=s),type:"text"},null,512),[[y,l.email.subject]])]),t("label",null,[e[32]||(e[32]=t("span",null,"邮件正文",-1)),u(t("textarea",{"onUpdate:modelValue":e[11]||(e[11]=s=>l.email.body=s),rows:"10"},null,512),[[y,l.email.body]])])])):(r(),p("p",kt,"尚未生成开发信草稿，请在主流程中生成后再进行编辑。"))]),t("section",Ct,[e[35]||(e[35]=t("h4",null,"自动跟进计划",-1)),t("div",Ut,[l.followup.next_due?(r(),p("div",$t,[e[34]||(e[34]=t("span",{class:"label"},"当前计划",-1)),t("span",null,c(T(l.followup.next_due)),1)])):D("",!0),t("div",xt,[(r(),p(U,null,$(m,s=>t("button",{key:s,type:"button",class:M(["ghost",{active:l.followup.delay===s}]),disabled:!l.email.email_id,onClick:a=>E(s)},c(s)+" 天后 ",11,Vt)),64))]),l.email.email_id?D("",!0):(r(),p("p",St,"保存前需要先有开发信草稿才能设置自动跟进。"))])])]),t("footer",Nt,[t("button",{class:"ghost",type:"button",onClick:h},"取消"),t("button",{class:"primary",type:"button",disabled:g.value,onClick:F},c(g.value?"保存中…":"保存"),9,Dt)])])):(r(),p("div",Tt,[...e[36]||(e[36]=[t("div",{class:"spinner"},null,-1),t("p",null,"加载客户信息…",-1)])]))]))}},Et=O(Lt,[["__scopeId","data-v-afd7f1b6"]]),Ft=async(d={})=>{const{data:n}=await A.get("/customers",{params:d});return n},jt=async d=>{const{data:n}=await A.get(`/customers/${d}`);return n},At=async d=>{const{data:n}=await A.delete(`/customers/${d}`);return n},Bt=z("customers",{state:()=>({loading:!1,items:[],filters:{grade:"",country:"",status:"",sort:"last_followup_desc",q:""},detailLoading:!1,detail:null}),actions:{async fetchList(d={}){const n=S();this.loading=!0;try{const i={...this.filters,...d};i.q||delete i.q;const b=await Ft(i);b.ok?this.items=b.data||[]:n.pushToast(b.error||"加载客户列表失败","error")}catch(i){console.error("Failed to load customers",i),n.pushToast(i.message,"error")}finally{this.loading=!1}},setFilter(d,n){Object.prototype.hasOwnProperty.call(this.filters,d)&&(this.filters[d]=n)},async fetchDetail(d){const n=S();this.detailLoading=!0;try{const i=await jt(d);i.ok?this.detail=i.data:n.pushToast(i.error||"加载客户详情失败","error")}catch(i){console.error("Failed to load customer detail",i),n.pushToast(i.message,"error")}finally{this.detailLoading=!1}},clearDetail(){this.detail=null},async removeCustomer(d){const n=S();if(!d)return n.pushToast("无效的客户 ID","error"),!1;try{const i=await At(d);return i.ok?(this.detail&&this.detail.id===d&&(this.detail=null),await this.fetchList(),n.pushToast("客户已删除","success"),!0):(n.pushToast(i.error||"删除客户失败","error"),!1)}catch(i){return console.error("Failed to delete customer",i),n.pushToast(i.message,"error"),!1}}}}),Ot={class:"customers"},Rt={class:"customers__toolbar"},Mt={class:"customers__filter"},It=["value"],Jt={class:"customers__filter"},qt=["value"],zt={class:"customers__filter"},Pt={class:"customers__filter"},Kt={class:"customers__table"},Wt={key:0},Zt={key:1},Gt={class:"name"},Ht={class:"title"},Qt={class:"hint"},Xt={class:"actions"},Yt=["onClick"],te=["onClick"],ee={__name:"CustomersPage",setup(d){const n=Bt(),{items:i,loading:b,detail:w,detailLoading:l,filters:f}=P(n),m=j({grade:f.value.grade,country:f.value.country,status:f.value.status,sort:f.value.sort}),g=N(()=>{const e=new Set(["S","A","B","C"]);return i.value.forEach(s=>{s.grade&&e.add(s.grade)}),Array.from(e)}),T=N(()=>{const e=new Set;return i.value.forEach(s=>{s.country&&e.add(s.country)}),Array.from(e).sort()}),L=N(()=>l.value||!!w.value),h=()=>{n.fetchList()},v=(e,s)=>{n.setFilter(e,s),h()};R(f,e=>{m.grade=e.grade,m.country=e.country,m.status=e.status,m.sort=e.sort});const x=e=>{if(!e)return"—";const s=new Date(e);return Number.isNaN(s.getTime())?e:s.toLocaleDateString()},E=async e=>{await n.fetchDetail(e)},V=()=>{n.clearDetail()},F=()=>{V(),h()},o=async e=>{if(!e||!e.id)return;const s=e.name?`「${e.name}」`:"该客户";window.confirm(`确定要删除${s}吗？此操作不可撤销。`)&&await n.removeCustomer(e.id)};return K(()=>{n.fetchList()}),W(()=>{}),(e,s)=>(r(),B(G,{step:0,total:0,title:"客户列表",subtitle:"集中查看并维护所有客户数据。"},{default:Z(()=>[t("section",Ot,[t("header",Rt,[t("label",Mt,[s[9]||(s[9]=t("span",null,"评级",-1)),u(t("select",{"onUpdate:modelValue":s[0]||(s[0]=a=>m.grade=a),onChange:s[1]||(s[1]=a=>v("grade",m.grade))},[s[8]||(s[8]=t("option",{value:""},"全部",-1)),(r(!0),p(U,null,$(g.value,a=>(r(),p("option",{key:a,value:a},c(a),9,It))),128))],544),[[C,m.grade]])]),t("label",Jt,[s[11]||(s[11]=t("span",null,"国家/地区",-1)),u(t("select",{"onUpdate:modelValue":s[2]||(s[2]=a=>m.country=a),onChange:s[3]||(s[3]=a=>v("country",m.country))},[s[10]||(s[10]=t("option",{value:""},"全部",-1)),(r(!0),p(U,null,$(T.value,a=>(r(),p("option",{key:a,value:a},c(a),9,qt))),128))],544),[[C,m.country]])]),t("label",zt,[s[13]||(s[13]=t("span",null,"跟进状态",-1)),u(t("select",{"onUpdate:modelValue":s[4]||(s[4]=a=>m.status=a),onChange:s[5]||(s[5]=a=>v("status",m.status))},[...s[12]||(s[12]=[t("option",{value:""},"全部",-1),t("option",{value:"pending"},"待跟进",-1),t("option",{value:"in_progress"},"跟进中",-1),t("option",{value:"won"},"已成交",-1)])],544),[[C,m.status]])]),t("label",Pt,[s[15]||(s[15]=t("span",null,"排序",-1)),u(t("select",{"onUpdate:modelValue":s[6]||(s[6]=a=>m.sort=a),onChange:s[7]||(s[7]=a=>v("sort",m.sort))},[...s[14]||(s[14]=[t("option",{value:"last_followup_desc"},"按最近跟进",-1),t("option",{value:"last_followup_asc"},"按最早跟进",-1),t("option",{value:"name_asc"},"按公司名 A → Z",-1),t("option",{value:"name_desc"},"按公司名 Z → A",-1)])],544),[[C,m.sort]])])]),t("div",Kt,[t("table",null,[s[18]||(s[18]=t("thead",null,[t("tr",null,[t("th",null,"公司"),t("th",null,"国家/地区"),t("th",null,"评级"),t("th",null,"最后跟进"),t("th",{class:"actions"},"操作")])],-1)),t("tbody",null,[k(b)?(r(),p("tr",Wt,[...s[16]||(s[16]=[t("td",{colspan:"5",class:"empty"},"加载中…",-1)])])):k(i).length?D("",!0):(r(),p("tr",Zt,[...s[17]||(s[17]=[t("td",{colspan:"5",class:"empty"},"暂无客户记录",-1)])])),(r(!0),p(U,null,$(k(i),a=>(r(),p("tr",{key:a.id},[t("td",Gt,[t("p",Ht,c(a.name),1),t("p",Qt,"最近更新时间："+c(x(a.updated_at)),1)]),t("td",null,c(a.country||"—"),1),t("td",null,[t("span",{class:M(["badge",`badge--${(a.grade||"unknown").toLowerCase()}`])},c(a.grade),3)]),t("td",null,c(x(a.last_followup_at)),1),t("td",Xt,[t("button",{type:"button",onClick:_=>E(a.id)},"编辑",8,Yt),t("button",{type:"button",class:"danger",onClick:_=>o(a)},"删除",8,te)])]))),128))])])])]),L.value?(r(),B(Et,{key:0,customer:k(w),loading:k(l),onClose:V,onUpdated:F},null,8,["customer","loading"])):D("",!0)]),_:1}))}},ae=O(ee,[["__scopeId","data-v-90de718b"]]);export{ae as default};
