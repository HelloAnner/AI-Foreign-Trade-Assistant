import{d as R,u as h,_ as j,r as k,w as C,c as r,a as t,t as g,b as a,e as v,f as u,v as c,F as I,g as S,n as b,h as T,i as B,o as d,j as E}from"./index-DaYgWqEB.js";import{h as m}from"./http-CZPNIr2s.js";const q=async l=>{const{data:o}=await m.post("/companies/resolve",{query:l});return o},M=async l=>{const{data:o}=await m.post("/companies",l);return o},N=async(l,o)=>{const{data:s}=await m.post(`/companies/${l}/contacts`,{contacts:o});return s},L=async l=>{const{data:o}=await m.post(`/companies/${l}/grade/suggest`);return o},z=async(l,o)=>{const{data:s}=await m.post(`/companies/${l}/grade/confirm`,o);return s},H=async l=>{const{data:o}=await m.post(`/companies/${l}/analysis`);return o},J=async(l,o)=>{const{data:s}=await m.put(`/companies/${l}/analysis`,o);return s},K=async l=>{const{data:o}=await m.post(`/companies/${l}/email-draft`);return o},O=async(l,o)=>{const{data:s}=await m.put(`/emails/${l}`,o);return s},P=async(l,o,s="")=>{const{data:f}=await m.post(`/companies/${l}/followup/first-save`,{email_id:o,notes:s});return f},Q=async l=>{const{data:o}=await m.post("/followups/schedule",l);return o},W=R("flow",{state:()=>({step:1,query:"",resolving:!1,resolveResult:null,contacts:[],summary:"",country:"",website:"",customerId:null,gradeSuggestion:null,gradeFinal:null,analysis:null,emailDraft:null,followupId:null,scheduledTask:null,loading:{grade:!1,analysis:!1,email:!1,followup:!1,schedule:!1}}),actions:{resetFlow(){this.step=1,this.query="",this.resolving=!1,this.resolveResult=null,this.contacts=[],this.summary="",this.country="",this.website="",this.customerId=null,this.gradeSuggestion=null,this.gradeFinal=null,this.analysis=null,this.emailDraft=null,this.followupId=null,this.scheduledTask=null,this.loading={grade:!1,analysis:!1,email:!1,followup:!1,schedule:!1}},async startResolve(l){const o=h();this.resolving=!0,this.query=l;try{const s=await q(l);this.resolveResult=s.data,this.contacts=s.data?.contacts||[],this.summary=s.data?.summary||"",this.country=s.data?.country||"",this.website=s.data?.website||"",this.step=1}catch(s){o.pushToast(s.message,"error")}finally{this.resolving=!1}},async saveCompany(l){const o=h();try{const s=await M({name:l.name,website:l.website||this.website,country:l.country||this.country,summary:l.summary||this.summary,contacts:this.contacts,source_json:this.resolveResult||{}});this.customerId=s.data.customer_id,this.website=l.website||this.website,this.country=l.country||this.country,this.summary=l.summary||this.summary,this.step=2,o.pushToast("客户信息已保存","success")}catch(s){o.pushToast(s.message,"error")}},async updateContacts(l){const o=h();if(this.contacts=l,!!this.customerId)try{await N(this.customerId,l),o.pushToast("联系人已更新","success")}catch(s){o.pushToast(s.message,"error")}},async fetchGrade(){if(!this.customerId)return;const l=h();this.loading.grade=!0;try{const o=await L(this.customerId);this.gradeSuggestion=o.data}catch(o){l.pushToast(o.message,"error")}finally{this.loading.grade=!1}},async confirmGrade(l,o=""){if(!this.customerId)return;const s=h();try{await z(this.customerId,{grade:l,reason:o}),this.gradeFinal={grade:l,reason:o},l==="A"?this.step=3:(this.step=5,s.pushToast("非 A 级客户，流程已归档","info"))}catch(f){s.pushToast(f.message,"error")}},async fetchAnalysis(){if(!this.customerId)return;const l=h();this.loading.analysis=!0;try{const o=await H(this.customerId);this.analysis=o.data,this.step=3}catch(o){l.pushToast(o.message,"error")}finally{this.loading.analysis=!1}},async persistAnalysis(){if(!this.customerId||!this.analysis)return;const l=h();try{await J(this.customerId,{core_business:this.analysis.core_business,pain_points:this.analysis.pain_points,my_entry_points:this.analysis.my_entry_points,full_report:this.analysis.full_report}),l.pushToast("分析内容已更新","success")}catch(o){l.pushToast(o.message,"error")}},async generateEmail(){if(!this.customerId)return;const l=h();this.loading.email=!0;try{const o=await K(this.customerId);this.emailDraft=o.data,this.step=4}catch(o){l.pushToast(o.message,"error")}finally{this.loading.email=!1}},async saveInitialFollowup(l=""){if(!this.customerId||!this.emailDraft)return;const o=h();this.loading.followup=!0;try{await O(this.emailDraft.email_id,{subject:this.emailDraft.subject,body:this.emailDraft.body});const s=await P(this.customerId,this.emailDraft.email_id,l);this.followupId=s.data.followup_id,this.step=5,o.pushToast("首次跟进记录已保存","success")}catch(s){o.pushToast(s.message,"error")}finally{this.loading.followup=!1}},async createSchedule(l){if(!this.customerId||!this.emailDraft)return;const o=h();this.loading.schedule=!0;try{const s=await Q({customer_id:this.customerId,context_email_id:this.emailDraft.email_id,delay_days:l});this.scheduledTask=s.data,o.pushToast(`已设置 ${l} 天后的自动跟进`,"success")}catch(s){o.pushToast(s.message,"error")}finally{this.loading.schedule=!1}}}}),X={class:"flow-layout"},Y={class:"flow-progress"},Z={class:"flow-content"},ss={class:"step-card"},ts={class:"step-card__body"},es={class:"form-row"},as=["disabled"],ls=["disabled"],os={key:0,class:"result-block"},is={class:"field-grid"},ns={key:0,class:"contacts-list"},rs=["onUpdate:modelValue"],ds=["onUpdate:modelValue"],us=["onUpdate:modelValue"],cs={class:"contact-key"},ps=["onUpdate:modelValue"],ms=["onClick"],ys={key:1,class:"empty-placeholder"},hs={class:"actions"},gs={class:"step-card__body"},fs={key:0,class:"empty-placeholder"},_s={key:1,class:"grade-block"},vs=["disabled"],bs={key:0,class:"grade-result"},ws={class:"reason"},ks={class:"grade-actions"},Cs={class:"step-card__body"},Is={key:0,class:"empty-placeholder"},Ss={key:1},Ts=["disabled"],Vs={key:0,class:"analysis-block"},xs={class:"step-card__body"},Ds={key:0,class:"empty-placeholder"},Us={key:1},As=["disabled"],Fs={key:0,class:"email-block"},$s={class:"actions"},Gs=["disabled"],Rs={class:"step-card__body"},js={key:0,class:"empty-placeholder"},Bs={key:1,class:"followup-block"},Es={class:"quick-buttons"},qs=["disabled","onClick"],Ms={key:0,class:"scheduled-info"},Ns={class:"actions"},Ls={__name:"MainFlow",setup(l){const o=B(),s=W(),f=k(""),p=k({name:"",website:"",country:"",summary:""}),y=k([]);C(()=>s.resolveResult,n=>{n&&(p.value={name:n?.name||s.query,website:n?.website||n?.candidates?.[0]?.url||"",country:n?.country||"",summary:n?.summary||""},y.value=(n?.contacts||[]).map(e=>({...e})))}),C(()=>s.step,n=>{n===1&&!s.resolveResult&&(f.value="",p.value={name:"",website:"",country:"",summary:""},y.value=[]),n===2&&!s.gradeSuggestion&&s.fetchGrade()}),C(()=>s.contacts,n=>{n&&(y.value=n.map(e=>({...e})))},{deep:!0});const V=()=>{s.startResolve(f.value)},x=()=>{s.contacts=y.value.map(n=>({...n})),s.saveCompany(p.value)},D=()=>{s.updateContacts(y.value.map(n=>({...n})))},U=()=>{y.value.push({name:"",title:"",email:"",is_key:y.value.length===0})},A=n=>{y.value.splice(n,1)},F=async()=>{await s.persistAnalysis(),s.step=4},$=()=>{o.push({name:"settings"})},G=n=>n?new Date(n).toLocaleString():"";return(n,e)=>(d(),r("div",X,[t("header",{class:"flow-header"},[e[19]||(e[19]=t("div",{class:"flow-header__title"},"AI 外贸客户开发助手",-1)),t("button",{class:"flow-header__settings",onClick:$},"设置")]),t("div",Y,"流程进度：第 "+g(a(s).step)+" 步 / 5",1),t("main",Z,[t("section",ss,[e[26]||(e[26]=t("div",{class:"step-card__head"},[t("div",null,[t("h2",{class:"step-card__title"},"Step 1 · 智能信息获取与聚合"),t("p",{class:"step-card__description"},"输入客户公司名或官网地址，系统自动聚合基础信息与联系人。")]),t("span",{class:"step-card__badge"},"必填")],-1)),t("div",ts,[t("div",es,[u(t("input",{"onUpdate:modelValue":e[0]||(e[0]=i=>f.value=i),disabled:a(s).resolving,type:"text",placeholder:"输入客户公司全名或官网地址"},null,8,as),[[c,f.value]]),t("button",{class:"primary",disabled:a(s).resolving||!f.value,onClick:V},g(a(s).resolving?"分析中...":"开始分析"),9,ls)]),a(s).resolveResult?(d(),r("div",os,[t("div",is,[t("label",null,[e[20]||(e[20]=t("span",null,"公司名称",-1)),u(t("input",{"onUpdate:modelValue":e[1]||(e[1]=i=>p.value.name=i),type:"text",placeholder:"如：Global Tech Inc."},null,512),[[c,p.value.name]])]),t("label",null,[e[21]||(e[21]=t("span",null,"官网",-1)),u(t("input",{"onUpdate:modelValue":e[2]||(e[2]=i=>p.value.website=i),type:"text",placeholder:"https://"},null,512),[[c,p.value.website]])]),t("label",null,[e[22]||(e[22]=t("span",null,"国家/地区",-1)),u(t("input",{"onUpdate:modelValue":e[3]||(e[3]=i=>p.value.country=i),type:"text",placeholder:"United States"},null,512),[[c,p.value.country]])])]),t("label",null,[e[23]||(e[23]=t("span",null,"AI 摘要",-1)),u(t("textarea",{"onUpdate:modelValue":e[4]||(e[4]=i=>p.value.summary=i),rows:"4",placeholder:"公司业务概览"},null,512),[[c,p.value.summary]])]),t("div",{class:"contacts-header"},[e[24]||(e[24]=t("div",null,[t("span",null,"潜在联系人"),t("small",null,"可编辑，新增重要联系人时勾选“重点”")],-1)),t("button",{class:"ghost",onClick:U},"新增联系人")]),y.value.length?(d(),r("div",ns,[(d(!0),r(I,null,S(y.value,(i,w)=>(d(),r("div",{key:w,class:"contact-row"},[u(t("input",{"onUpdate:modelValue":_=>i.name=_,type:"text",placeholder:"姓名"},null,8,rs),[[c,i.name]]),u(t("input",{"onUpdate:modelValue":_=>i.title=_,type:"text",placeholder:"职位"},null,8,ds),[[c,i.title]]),u(t("input",{"onUpdate:modelValue":_=>i.email=_,type:"email",placeholder:"邮箱"},null,8,us),[[c,i.email]]),t("label",cs,[u(t("input",{type:"checkbox","onUpdate:modelValue":_=>i.is_key=_},null,8,ps),[[E,i.is_key]]),e[25]||(e[25]=T(" 重点 ",-1))]),t("button",{class:"ghost",onClick:_=>A(w)},"删除",8,ms)]))),128))])):(d(),r("div",ys,"暂无联系人，请手动添加。")),t("div",hs,[t("button",{class:"primary",onClick:x},"保存并继续"),a(s).customerId?(d(),r("button",{key:0,class:"ghost",onClick:D},"更新联系人")):v("",!0)])])):v("",!0)])]),t("section",{class:b(["step-card",{"step-card--disabled":!a(s).customerId}])},[e[28]||(e[28]=t("div",{class:"step-card__head"},[t("div",null,[t("h2",{class:"step-card__title"},"Step 2 · AI 辅助客户价值评级"),t("p",{class:"step-card__description"},"基于评级规则自动给出 A/B/C 建议，可人工调整。")])],-1)),t("div",gs,[a(s).customerId?(d(),r("div",_s,[t("button",{class:"primary",disabled:a(s).loading.grade,onClick:e[5]||(e[5]=(...i)=>a(s).fetchGrade&&a(s).fetchGrade(...i))},g(a(s).loading.grade?"评估中...":"获取 AI 评级"),9,vs),a(s).gradeSuggestion?(d(),r("div",bs,[t("p",null,[e[27]||(e[27]=T("AI 建议等级：",-1)),t("strong",null,g(a(s).gradeSuggestion.suggested_grade),1)]),t("p",ws,"理由："+g(a(s).gradeSuggestion.reason),1),t("div",ks,[t("button",{class:"primary",onClick:e[6]||(e[6]=i=>a(s).confirmGrade("A",a(s).gradeSuggestion.reason))},"确认 A 级"),t("button",{class:"ghost",onClick:e[7]||(e[7]=i=>a(s).confirmGrade("B",a(s).gradeSuggestion.reason))},"调整为 B 级"),t("button",{class:"ghost",onClick:e[8]||(e[8]=i=>a(s).confirmGrade("C",a(s).gradeSuggestion.reason))},"调整为 C 级")])])):v("",!0)])):(d(),r("div",fs,"请先完成 Step 1。"))])],2),t("section",{class:b(["step-card",{"step-card--disabled":a(s).step<3}])},[e[33]||(e[33]=t("div",{class:"step-card__head"},[t("div",null,[t("h2",{class:"step-card__title"},"Step 3 · 生成产品切入点分析"),t("p",{class:"step-card__description"},"结合客户业务与我方优势，生成可编辑的切入报告。")])],-1)),t("div",Cs,[a(s).step<3?(d(),r("div",Is,"请先完成前两步。")):(d(),r("div",Ss,[t("button",{class:"primary",disabled:a(s).loading.analysis,onClick:e[9]||(e[9]=(...i)=>a(s).fetchAnalysis&&a(s).fetchAnalysis(...i))},g(a(s).loading.analysis?"生成中...":a(s).analysis?"重新生成":"生成分析"),9,Ts),a(s).analysis?(d(),r("div",Vs,[t("label",null,[e[29]||(e[29]=t("span",null,"核心业务",-1)),u(t("textarea",{"onUpdate:modelValue":e[10]||(e[10]=i=>a(s).analysis.core_business=i),rows:"3"},null,512),[[c,a(s).analysis.core_business]])]),t("label",null,[e[30]||(e[30]=t("span",null,"潜在痛点",-1)),u(t("textarea",{"onUpdate:modelValue":e[11]||(e[11]=i=>a(s).analysis.pain_points=i),rows:"3"},null,512),[[c,a(s).analysis.pain_points]])]),t("label",null,[e[31]||(e[31]=t("span",null,"我方切入点",-1)),u(t("textarea",{"onUpdate:modelValue":e[12]||(e[12]=i=>a(s).analysis.my_entry_points=i),rows:"3"},null,512),[[c,a(s).analysis.my_entry_points]])]),t("label",null,[e[32]||(e[32]=t("span",null,"完整报告",-1)),u(t("textarea",{"onUpdate:modelValue":e[13]||(e[13]=i=>a(s).analysis.full_report=i),rows:"5"},null,512),[[c,a(s).analysis.full_report]])]),t("div",{class:"actions"},[t("button",{class:"primary",onClick:F},"保存并继续")])])):v("",!0)]))])],2),t("section",{class:b(["step-card",{"step-card--disabled":a(s).step<4}])},[e[36]||(e[36]=t("div",{class:"step-card__head"},[t("div",null,[t("h2",{class:"step-card__title"},"Step 4 · 生成个性化开发信"),t("p",{class:"step-card__description"},"一键生成开发信草稿，确认后保存为首次跟进记录。")])],-1)),t("div",xs,[a(s).step<4?(d(),r("div",Ds,"请先生成切入点分析。")):(d(),r("div",Us,[t("button",{class:"primary",disabled:a(s).loading.email,onClick:e[14]||(e[14]=(...i)=>a(s).generateEmail&&a(s).generateEmail(...i))},g(a(s).loading.email?"生成中...":a(s).emailDraft?"重新生成":"生成开发信"),9,As),a(s).emailDraft?(d(),r("div",Fs,[t("label",null,[e[34]||(e[34]=t("span",null,"邮件标题",-1)),u(t("input",{"onUpdate:modelValue":e[15]||(e[15]=i=>a(s).emailDraft.subject=i),type:"text"},null,512),[[c,a(s).emailDraft.subject]])]),t("label",null,[e[35]||(e[35]=t("span",null,"邮件正文",-1)),u(t("textarea",{"onUpdate:modelValue":e[16]||(e[16]=i=>a(s).emailDraft.body=i),rows:"8"},null,512),[[c,a(s).emailDraft.body]])]),t("div",$s,[t("button",{class:"primary",disabled:a(s).loading.followup,onClick:e[17]||(e[17]=i=>a(s).saveInitialFollowup())},g(a(s).loading.followup?"保存中...":"保存为首次跟进记录"),9,Gs)])])):v("",!0)]))])],2),t("section",{class:b(["step-card",{"step-card--disabled":a(s).step<5}])},[e[37]||(e[37]=t("div",{class:"step-card__head"},[t("div",null,[t("h2",{class:"step-card__title"},"Step 5 · 设置自动化邮件跟进"),t("p",{class:"step-card__description"},"选择跟进时间，系统将在到期时自动生成并发送邮件。")])],-1)),t("div",Rs,[a(s).step<5?(d(),r("div",js,"请先保存首次跟进记录。")):(d(),r("div",Bs,[t("div",Es,[(d(),r(I,null,S([3,7,14],i=>t("button",{key:i,class:"ghost",disabled:a(s).loading.schedule,onClick:w=>a(s).createSchedule(i)},g(i)+" 天后跟进",9,qs)),64))]),a(s).scheduledTask?(d(),r("div",Ms," 已设置任务，计划发送时间："+g(G(a(s).scheduledTask.due_at)),1)):v("",!0),t("div",Ns,[t("button",{class:"primary",onClick:e[18]||(e[18]=(...i)=>a(s).resetFlow&&a(s).resetFlow(...i))},"完成并开始下一个")])]))])],2)])]))}},Js=j(Ls,[["__scopeId","data-v-bcc21469"]]);export{Js as default};
