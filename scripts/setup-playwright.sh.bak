#!/bin/bash

# AI å¤–è´¸åŠ©æ‰‹ - Playwright å®‰è£…è„šæœ¬
# ä½¿ç”¨æ–¹æ³•ï¼šbash scripts/setup-playwright.sh [output-dir]

set -euo pipefail

ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
PLAYWRIGHT_VERSION="1.49.1"  # åŒ¹é… playwright-go v0.4902.0

# èŽ·å–ç›®æ ‡å¹³å°å‚æ•°ï¼ˆç”¨äºŽäº¤å‰ç¼–è¯‘ï¼‰
TARGET_OS="${2:-}"
TARGET_ARCH="${3:-}"

# è¾“å‡ºç›®å½•ï¼ˆé»˜è®¤ä¸º bin/playwrightï¼‰
OUTPUT_DIR="${1:-$ROOT_DIR/bin/playwright}"
NODE_DIR="$OUTPUT_DIR/node"
BROWSER_DIR="$OUTPUT_DIR/browsers"

echo "ðŸ“¦ å¼€å§‹å®‰è£… Playwright..."
echo "è¾“å‡ºç›®å½•ï¼š$OUTPUT_DIR"

# æ£€æµ‹å½“å‰å¹³å°
HOST_OS=$(uname -s | tr '[:upper:]' '[:lower:]')
echo "å½“å‰æž„å»ºå¹³å°: $HOST_OS"

if [ -n "$TARGET_OS" ] && [ "$TARGET_OS" != "$HOST_OS" ]; then
    echo "âš ï¸  è­¦å‘Šï¼šæ­£åœ¨ä¸º $TARGET_OS å¹³å°å®‰è£… Playwrightï¼ˆå½“å‰ç³»ç»Ÿï¼š$HOST_OSï¼‰"
    echo "   è¿™å°†åœ¨ä¸‹è½½ Node.js å’Œæµè§ˆå™¨æ—¶å°è¯•äº¤å‰å¹³å°å®‰è£…"
    echo ""
fi

# ç¡®ä¿ç›®å½•å­˜åœ¨
mkdir -p "$OUTPUT_DIR"
mkdir -p "$NODE_DIR"
mkdir -p "$BROWSER_DIR"

# 1. å®‰è£… Node.js è¿è¡Œæ—¶ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
if [ ! -f "$NODE_DIR/bin/node" ]; then
    echo "[1/5] ä¸‹è½½ Node.js..."

    # æ£€æµ‹å¹³å°ï¼ˆå¦‚æžœæœªæŒ‡å®šç›®æ ‡å¹³å°ï¼Œåˆ™ä½¿ç”¨å½“å‰å¹³å°ï¼‰
    if [ -n "$TARGET_OS" ] && [ -n "$TARGET_ARCH" ]; then
        OS="$TARGET_OS"
        ARCH="$TARGET_ARCH"
        echo "ä½¿ç”¨ç›®æ ‡å¹³å°: $OS/$ARCH"
    else
        OS=$(uname -s | tr '[:upper:]' '[:lower:]')
        ARCH=$(uname -m)
        echo "ä½¿ç”¨å½“å‰å¹³å°: $OS/$ARCH"
    fi

    case "$OS" in
        linux)
            NODE_OS="linux"
            ;;
        darwin)
            NODE_OS="darwin"
            ;;
        msys*|mingw*|cygwin*)
            NODE_OS="win"
            ;;
        *)
            echo "âŒ ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ: $OS"
            exit 1
            ;;
    esac

    case "$ARCH" in
        x86_64)
            NODE_ARCH="x64"
            ;;
        arm64|aarch64)
            NODE_ARCH="arm64"
            ;;
        *)
            echo "âŒ ä¸æ”¯æŒçš„æž¶æž„: $ARCH"
            exit 1
            ;;
    esac

    NODE_VERSION="20.11.0"
    NODE_FILENAME="node-v${NODE_VERSION}-${NODE_OS}-${NODE_ARCH}"

    if [ "$NODE_OS" = "win" ]; then
        NODE_FILENAME="${NODE_FILENAME}.zip"
    else
        NODE_FILENAME="${NODE_FILENAME}.tar.gz"
    fi

    # ä¸‹è½½ Node.js
    cd /tmp
    echo "   ä¸‹è½½: https://nodejs.org/dist/v${NODE_VERSION}/${NODE_FILENAME}"
    if curl -L -o "$NODE_FILENAME" "https://nodejs.org/dist/v${NODE_VERSION}/${NODE_FILENAME}" 2>/dev/null; then
        echo "   ä¸‹è½½å®Œæˆ"
    else
        echo "âŒ ä¸‹è½½å¤±è´¥"
        rm -f "$NODE_FILENAME"
        exit 1
    fi

    # è§£åŽ‹
    echo "   è§£åŽ‹ $NODE_FILENAME..."
    if [ "$NODE_OS" = "win" ]; then
        if command -v unzip >/dev/null 2>&1; then
            unzip -q "$NODE_FILENAME" && mv "node-v${NODE_VERSION}-${NODE_OS}-${NODE_ARCH}" node-tmp
        else
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° unzip å‘½ä»¤ï¼Œæ— æ³•è§£åŽ‹ Windows Node.js åŒ…"
            rm -f "$NODE_FILENAME"
            exit 1
        fi
    else
        tar -xzf "$NODE_FILENAME" && mv "node-v${NODE_VERSION}-${NODE_OS}-${NODE_ARCH}" node-tmp
    fi

    if [ $? -ne 0 ]; then
        echo "âŒ è§£åŽ‹å¤±è´¥"
        rm -rf node-tmp
        rm -f "$NODE_FILENAME"
        exit 1
    fi

    # ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®
    if [ -d "node-tmp" ]; then
        mv node-tmp/* "$NODE_DIR/" 2>/dev/null || cp -R node-tmp/* "$NODE_DIR/"
        rm -rf node-tmp
        rm -f "$NODE_FILENAME"
        echo "âœ“ Node.js å®‰è£…å®Œæˆ"
    else
        echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°è§£åŽ‹åŽçš„ç›®å½•"
        rm -f "$NODE_FILENAME"
        exit 1
    fi
else
    echo "âœ“ Node.js å·²å­˜åœ¨ï¼Œè·³è¿‡ä¸‹è½½"
fi

# 2. å®‰è£… Playwright NPM åŒ…
echo "[2/4] å®‰è£… Playwright NPM åŒ…..."

cd "$OUTPUT_DIR"

# åˆå§‹åŒ– package.jsonï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
if [ ! -f "package.json" ]; then
    "$NODE_DIR/bin/npm" init -y
fi

# å®‰è£… Playwright CLI
"$NODE_DIR/bin/npm" install --save-dev @playwright/test@"$PLAYWRIGHT_VERSION"

# 3. å®‰è£…æµè§ˆå™¨
echo "[3/4] å®‰è£… Playwright æµè§ˆå™¨..."

# è®¾ç½®æµè§ˆå™¨å®‰è£…è·¯å¾„
export PLAYWRIGHT_BROWSERS_PATH="$BROWSER_DIR"

# å®‰è£… Chromium
"$NODE_DIR/bin/npx" playwright install chromium

echo "âœ“ æµè§ˆå™¨å®‰è£…å®Œæˆ"

# 4. å‡†å¤‡ Playwright é©±åŠ¨ç›®å½•ï¼ˆç”¨äºŽ playwright-goï¼‰
echo "[4/5] å‡†å¤‡ Playwright Go é©±åŠ¨ç›®å½•..."

# åˆ›å»º playwright-go æ‰€éœ€çš„é©±åŠ¨ç›®å½•ç»“æž„
# playwright-go æœŸæœ› PLAYWRIGHT_DRIVER_PATH æŒ‡å‘åŒ…å« package/playwright/ çš„ç›®å½•
# å³ node_modules/@playwright/test/node_modules/playwright
DRIVER_SOURCE_DIR="${OUTPUT_DIR}/node_modules/playwright"
DRIVER_TARGET_DIR="${OUTPUT_DIR}/playwright-driver"

if [ -d "$DRIVER_SOURCE_DIR" ]; then
    # å¤åˆ¶ playwright ç›®å½•åˆ°ç›®æ ‡ä½ç½®
    cp -R "$DRIVER_SOURCE_DIR" "$DRIVER_TARGET_DIR"
    echo "âœ“ é©±åŠ¨ç›®å½•åˆ›å»ºå®Œæˆ: ${OUTPUT_DIR}/playwright-driver"
else
    echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° playwright é©±åŠ¨æºç›®å½•: $DRIVER_SOURCE_DIR"
    exit 1
fi

# 4.1 éªŒè¯é©±åŠ¨å®Œæ•´æ€§
echo "[4.5/5] éªŒè¯é©±åŠ¨å®Œæ•´æ€§..."
MISSING_FILES=0

# æ£€æŸ¥å¿…è¦æ–‡ä»¶
if [ ! -f "$DRIVER_TARGET_DIR/package.json" ]; then
    echo "âš  è­¦å‘Š: ç¼ºå°‘ package.json"
    MISSING_FILES=$((MISSING_FILES + 1))
fi

if [ ! -d "$DRIVER_TARGET_DIR/lib" ]; then
    echo "âš  è­¦å‘Š: ç¼ºå°‘ lib/ ç›®å½•"
    MISSING_FILES=$((MISSING_FILES + 1))
fi

if [ ! -d "$DRIVER_TARGET_DIR/node_modules" ] && [ ! -d "$DRIVER_TARGET_DIR/../node_modules" ]; then
    echo "âš  è­¦å‘Š: ç¼ºå°‘ node_modules (å¯èƒ½ä¸æ˜¯å…³é”®)"
fi

# æ£€æŸ¥æµè§ˆå™¨
BROWSER_COUNT=$(ls -1 "$BROWSER_DIR" 2>/dev/null | wc -l)
if [ "$BROWSER_COUNT" -lt 2 ]; then
    echo "âš  è­¦å‘Š: æµè§ˆå™¨å®‰è£…å¯èƒ½ä¸å®Œæ•´ (æ‰¾åˆ° $BROWSER_COUNT ä¸ª)"
else
    echo "âœ“ æ£€æµ‹åˆ° $BROWSER_COUNT ä¸ªæµè§ˆå™¨å®‰è£…"
fi

if [ $MISSING_FILES -eq 0 ]; then
    echo "âœ“ é©±åŠ¨å®Œæ•´æ€§éªŒè¯é€šè¿‡"
else
    echo "âš  é©±åŠ¨å®Œæ•´æ€§éªŒè¯å‘çŽ° $MISSING_FILES ä¸ªé—®é¢˜"
fi

# 4.2 éªŒè¯ç‰ˆæœ¬åŒ¹é…
echo "[4.6/5] éªŒè¯ç‰ˆæœ¬åŒ¹é…..."
NPM_VERSION=$(cd "$OUTPUT_DIR" && "$NODE_DIR/bin/npm" list @playwright/test 2>/dev/null | grep @playwright/test | sed 's/.*@//' | head -1)
DRIVER_VERSION=$(grep '"version"' "$DRIVER_TARGET_DIR/package.json" 2>/dev/null | sed 's/.*"\(.*\)".*/\1/')

if [ "$NPM_VERSION" = "$DRIVER_VERSION" ]; then
    echo "âœ“ ç‰ˆæœ¬åŒ¹é…: $NPM_VERSION"
else
    echo "âš  ç‰ˆæœ¬å¯èƒ½ä¸åŒ¹é…: npm=$NPM_VERSION, driver=$DRIVER_VERSION"
fi

# 5. åˆ›å»ºå¯åŠ¨è„šæœ¬
echo "[5/5] åˆ›å»ºå¯åŠ¨è„šæœ¬..."

cat > "$OUTPUT_DIR/playwright-path.sh" << 'EOF'
#!/bin/bash
# è®¾ç½® Playwright çŽ¯å¢ƒå˜é‡
DIR="$(cd "$(dirname "$0")" && pwd)"
export PLAYWRIGHT_NODE_HOME="$DIR/node"
export PLAYWRIGHT_BROWSERS_PATH="$DIR/browsers"
export PLAYWRIGHT_DRIVER_PATH="$DIR/playwright-driver"
export PATH="$DIR/node/bin:$PATH"
EOF

chmod +x "$OUTPUT_DIR/playwright-path.sh"

echo ""
echo "ðŸŽ‰ Playwright å®‰è£…å®Œæˆï¼"
echo ""
echo "éªŒè¯æ­¥éª¤ï¼š"
echo "1. éªŒè¯ Playwright: source $OUTPUT_DIR/playwright-path.sh && npx playwright --version"
echo "2. éªŒè¯æµè§ˆå™¨: ls -lh $BROWSER_DIR"
echo "3. éªŒè¯é©±åŠ¨: ls -lh $OUTPUT_DIR/playwright-driver/package.json"
echo "4. æµ‹è¯•è¿è¡Œ: cd "$ROOT_DIR/backend" && go run -exec 'env PLAYWRIGHT_DRIVER_PATH=$OUTPUT_DIR/playwright-driver' ."
echo ""
echo "ç›®å½•ç»“æž„ï¼š"
echo "  node/           Node.js runtime"
echo "  node_modules/   NPM packages"
echo "  browsers/       Playwright browsers"
echo "  playwright-driver/  Go driver for playwright-go"
echo ""
echo "çŽ¯å¢ƒå˜é‡ï¼š"
echo "  PLAYWRIGHT_DRIVER_PATH=$OUTPUT_DIR/playwright-driver"
echo "  PLAYWRIGHT_BROWSERS_PATH=$BROWSER_DIR"
echo ""
